## keydb的replication

Keydb replication

https://docs.keydb.dev/docs/replication/

redis replication

https://redis.io/topics/replication

 

keyDB replication工作方式

> master数据集的确切版本由以下给定的一对标识决定

```
Replication ID、offset
```

1、 Replication ID （复制ID）

master数据库有一个replication ID（一个大的伪随机字符串）

复制ID基本上标记了数据集的给定历史记录。每次实例作为master从头重新启动，或slave升级为master时，都会为此实例生成一个新的复制ID。握手后，连接到master的slave将继承master的复制ID。因此，具有相同ID的两个实例通过以下事实相关联：它们拥有相同的数据，但可能在不同的时间。对于拥有最新数据集的给定历史记录（复制ID），这是理解逻辑时间的偏移量。

例如，如果两个实例A和B具有相同的复制ID，但一个实例的偏移量为1000，另一个实例的偏移量为1023，则意味着第一个实例缺少应用于数据集的某些命令。这也意味着，仅通过应用一些命令，A即可达到与B完全相同的状态。

KeyDB实例具有两个复制ID的原因是因为从属服务器被提升为主服务器。故障转移后，升级的从属服务器仍然需要记住其过去的复制ID，因为该复制ID是以前的主服务器之一。这样，当其他从属服务器将与新的主服务器同步时，它们将尝试使用旧的主服务器复制ID执行部分重新同步。这将按预期工作，因为当从属设备升级为主设备时，它会将其辅助ID设置为其主要ID，并记住发生此ID切换时的偏移量。稍后它将选择一个新的随机复制ID，因为新的历史记录开始了。在处理新的从属连接时，主设备将其ID和偏移量与当前ID和辅助ID匹配（为了安全起见，直到给定的偏移量）。

2、 offset

还有一个偏移量，该偏移量针对复制流中要发送给从服务器的复制流的每个字节而增加，以便使用修改数据集的新更改来更新从服务器的状态

就算实际没有连接任何slave，复制偏移也会增加？？不理解

复制方式

当slave连接到master时，它们使用PSYNC命令来发送其旧的master的replication ID和到目前为止已处理的offset。这样master可以只发送所需的增量部分。但是，如果master缓冲区中的backlog不足，或者slave正在引用的历史记录（replication ID）不再已知，那么会发生完全重新同步：在这种情况下，slave将获得数据集的完整副本，从头开始。

完全同步

master启动后台保存进程以生成RDB文件。同时，它开始缓冲从客户端收到的所有新写命令。后台保存完成后，master将数据库文件传输到slave，slave将其保存在磁盘上，然后将其加载到内存中。然后，master将所有缓冲命令发送到slave。这是作为命令流完成的，并且格式与KeyDB协议本身相同。

可以通过telnet尝试上述过程：当服务器正在执行某些工作时，请连接到KeyDB端口并发出SYNC命令。将看到批量传输，然后master收到的每个命令都会在telnet会话中重新发出。实际上，SYNC是一个较旧的协议，新的KeyDB实例不再使用该协议，但仍存在该协议是为了向后兼容：它不允许部分重新同步，因此现在PSYNC使用它。

如前所述，当主从链路由于某种原因断开时，slave能够自动重新连接。如果master收到多个并发的slave同步请求，它将执行一次后台保存，以便为所有请求提供服务。

无盘复制

通常，完全重新同步需要在磁盘上创建RDB文件，然后从磁盘重新加载相同的RDB，以便为从站提供数据。

对于慢速磁盘，这对于主服务器而言可能是非常压力的操作。KeyDB 2.8.18版是第一个支持无盘复制的版本。在这种设置中，子进程直接通过电报的方式将RDB发送到从属服务器，而无需使用磁盘作为中间存储。

重新启动和故障转移后的部分重新同步

从KeyDB 4.0开始，在故障转移后将实例提升为主节点时，它仍将能够与旧主节点的从节点执行部分重新同步。为此，从属服务器会记住旧的复制ID及其以前的主服务器的偏移量，因此即使连接的从属服务器要求提供旧的复制ID，也可以将部分积压提供给连接的从属服务器。

但是，升级后的从属的新复制ID将有所不同，因为它构成了数据集的不同历史记录。例如，主服务器可以返回可用状态，并且可以继续接受写入一段时间，因此在提升的从服务器中使用相同的复制ID会违反复制ID和偏移对a仅标识单个数据集的规则。

此外，从属设备在轻轻关闭电源并重新启动后，能够在RDB文件中存储 与主设备重新同步所需的信息。这在升级时很有用。如果需要，最好使用该SHUTDOWN命令以便save & quit在从站上执行操作。

 

不能部分重新同步通过AOF文件重新启动的从站。但是，可以在关闭实例之前将实例转换为RDB持久性，然后再重新启动，最后可以再次启用AOF。